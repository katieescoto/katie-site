machine:
  timezone:
    America/Los_Angeles
  php:
    version: 7.0.7
  environment:
    PATH: $HOME/$CIRCLE_PROJECT_REPONAME/vendor/bin:$HOME/vendor/bin:$PATH
    SERVER: site.dev
  hosts:
    localhost: 127.0.0.1
    SERVER: 127.0.0.1
dependencies:
  cache_directories:
    - ~/.composer/cache
  pre:
    # Install a more current version of git.
    - sudo apt-get update; sudo apt-get install git
    #- echo "date.timezone = America/Los_Angeles" > /opt/circleci/php/$(phpenv global)/etc/conf.d/timezone.ini
    - rm /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini
    - composer global require "hirak/prestissimo:^0.3"
    - sudo cp circle.conf /etc/apache2/sites-available
    - sudo sed -e "s?%HOME%?$(pwd)?g" --in-place /etc/apache2/sites-available/circle.conf
    - sudo sed -e "s?%PROJECT_DIR%?web?g" --in-place /etc/apache2/sites-available/circle.conf
    - sudo sed -e "s?%SERVER%?$SERVER?g" --in-place /etc/apache2/sites-available/circle.conf
    - sudo a2enmod rewrite
    - sudo rm /etc/apache2/mods-enabled/php5.load
    - sudo a2ensite circle.conf
    - sudo service apache2 restart
    - composer install
  post:
    - echo 'sendmail_path = /bin/true' >> /opt/circleci/php/$(phpenv global)/etc/conf.d/circle.ini
database:
  override:
    - robo config --db-name=circle_test --db-user=circle --db-pass=NULL --db-host=127.0.0.1
    - robo install
test:
  pre:
    - start-webserver:
        background: true

  override:
    - behat --profile=ci --config behat/behat.ci.yml --format progress
  post:
    - stop-webserver
